# 架构设计

## 系统架构

Imperishable Gate 采用**前后端分离架构**：
- **后端服务**：基于 Go + Echo + PostgreSQL + GORM 构建的高性能 RESTful API 服务
- **CLI 客户端**：基于 Cobra 框架的强大命令行工具，支持跨平台使用

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      CLI Client (gate)                      │
│  ┌──────────────┐   ┌──────────────┐  ┌──────────────────┐  │
│  │   Commands   │   │   Services   │  │  System Keyring  │  │
│  └──────┬───────┘   └──────┬───────┘  └────────┬─────────┘  │
│         │                  │                   │            │
│         └──────────────────┴───────────────────┘            │
│                            │                                │
│                       HTTP/JSON                             │
└────────────────────────────┼────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                       RESTful API                           │
│  ┌─────────────────────────┴─────────────────────────────┐  │
│  │              Echo Web Framework                       │  │
│  │  ┌──────────┐  ┌────────────┐  ┌─────────────────┐    │  │
│  │  │  Routes  │→ │ Middleware │→ │    Handlers     │    │  │
│  │  └──────────┘  └────────────┘  └────────┬────────┘    │  │
│  │                                         │             │  │
│  └─────────────────────────────────────────┼─────────────┘  │
│                                            │                │
│  ┌─────────────────────────────────────────┼─────────────┐  │
│  │                  Services               │             │  │
│  │  ┌────────────┐  ┌──────────┐  ┌────────┴─────────┐   │  │
│  │  │    JWT     │  │ Metadata │  │   Link Monitor   │   │  │
│  │  │  Service   │  │  Crawler │  │  (Goroutines)    │   │  │
│  │  └────────────┘  └──────────┘  └──────────────────┘   │  │
│  └───────────────────────────────────────────────────────┘  │
│                             │                               │
│                         GORM ORM                            │
└─────────────────────────────┼───────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────┐
│                       PostgreSQL                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │  users   │  │  links   │  │   tags   │  │  names   │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│  ┌──────────────────────┐  ┌──────────────────────┐         │
│  │   refresh_tokens     │  │     link_tags        │         │
│  └──────────────────────┘  └──────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 目录结构

```
cmd/
  gate/             # CLI 客户端入口
  gate-server/      # 服务端入口
internal/
  client/           # 客户端实现
    cmd/            # CLI 命令定义
    service/        # 客户端业务逻辑
    utils/          # 客户端工具函数
  model/            # 数据模型与实体
  server/           # 服务端核心逻辑
    database/       # 数据库初始化与迁移
    handlers/       # HTTP 请求处理
    middlewares/    # 中间件（JWT 认证等）
    routes/         # 路由注册
    service/        # 服务端业务逻辑
    utils/          # 服务端工具函数
  types/            # 类型定义
    request/        # 请求类型
    response/       # 响应类型
    jwt/            # JWT 相关类型
    data/           # 数据类型
```

## 核心组件

### 后端组件

#### 1. Echo Web 框架
- 高性能的 HTTP 路由和中间件
- RESTful API 设计
- 请求/响应处理

#### 2. GORM + PostgreSQL
- 数据持久化
- 关系映射
- 数据库迁移

#### 3. JWT 认证服务
- Access Token（短期）
- Refresh Token（长期）
- 自动令牌刷新机制

#### 4. 元数据爬虫
- 自动抓取网页标题、描述、关键词
- 支持并发抓取

#### 5. 链接监控服务
- 定时检查链接状态
- 内容变化检测
- 邮件通知（可选）

### 客户端组件

#### 1. Cobra CLI 框架
- 命令行界面
- 参数解析
- 子命令管理

#### 2. 系统 Keyring 集成
- 安全存储令牌
- 跨平台支持（Linux/macOS/Windows）

#### 3. HTTP 客户端
- RESTful API 调用
- 自动令牌管理
- 错误处理

## 数据模型

### User（用户）
- ID：主键
- Username：用户名（唯一）
- Password：密码（bcrypt 加密）
- Email：邮箱
- EmailVerified：邮箱验证状态
- Links：关联的链接列表
- Tags：关联的标签列表

### Link（链接）
- ID：主键
- UserID：所属用户 ID
- Url：链接地址（用户内唯一）
- Tags：多对多关联的标签
- Names：一对多关联的别名
- Remark：备注信息
- Title：网页标题（自动抓取）
- Description：网页描述（自动抓取）
- Keywords：网页关键词（自动抓取）
- Watching：是否监控
- StatusCode：HTTP 状态码
- ContentHash：内容哈希（用于检测变化）

### Tag（标签）
- ID：主键
- UserID：所属用户 ID
- Name：标签名（用户内唯一）
- Links：多对多关联的链接

### Name（别名）
- ID：主键
- LinkID：所属链接 ID
- Name：别名（全局唯一）

### RefreshToken（刷新令牌）
- ID：主键
- UserID：所属用户 ID
- Token：令牌字符串（唯一）
- ExpiresAt：过期时间
- CreatedAt：创建时间

## 技术栈

### 后端技术
- **Go 1.25.1+**：编程语言
- **Echo v4**：Web 框架
- **GORM**：ORM 框架
- **PostgreSQL**：关系型数据库
- **golang-jwt/jwt v5**：JWT 认证
- **goquery**：网页抓取
- **bcrypt**：密码加密

### 客户端技术
- **Cobra**：CLI 框架
- **go-keyring**：凭证存储
- **net/http**：HTTP 客户端
